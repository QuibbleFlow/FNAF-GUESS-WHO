<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FNAF GUESS WHO</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Creepster&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

:root {
  --red:#cc0000; --red-bright:#ff2200; --red-glow:rgba(255,34,0,0.5);
  --green:#00ff41; --green-dim:#00aa2a; --green-glow:rgba(0,255,65,0.3);
  --gold:#ffd700; --gold-glow:rgba(255,215,0,0.4);
  --purple:#9b59b6; --purple-glow:rgba(155,89,182,0.4);
  --bg:#030303; --panel:#0a0a0a; --border:#2a0000;
  --text:#e0e0e0; --text-dim:#666;
  --mono:'Share Tech Mono',monospace; --title:'Creepster',cursive; --hud:'Orbitron',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--mono);}

body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);pointer-events:none;z-index:9999;}

.bg-layer{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at 20% 50%,rgba(100,0,0,0.08) 0%,transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(100,0,0,0.06) 0%,transparent 60%),url('background.jpeg') center/cover no-repeat;background-color:var(--bg);}
.bg-layer::before{content:'';position:absolute;inset:0;background:rgba(0,0,0,0.88);}

.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;}
.screen.active{display:flex;}

/* GLITCH ‚Äî isolated via will-change so browser promotes to own GPU layer */
.glitch-title{
  font-family:var(--title);font-size:clamp(2.5rem,8vw,5rem);
  color:var(--red-bright);
  text-shadow:0 0 20px var(--red-glow),0 0 60px rgba(255,0,0,0.2);
  letter-spacing:4px;
  position:relative;
  display:inline-block;
  will-change:transform;
  animation:glitchAnim 6s infinite;
}
.glitch-title::before,.glitch-title::after{
  content:attr(data-text);position:absolute;top:0;left:0;width:100%;
  pointer-events:none;
}
.glitch-title::before{color:#0ff;clip-path:polygon(0 0,100% 0,100% 35%,0 35%);opacity:.7;animation:glitchTop 5s infinite;}
.glitch-title::after{color:var(--red-bright);clip-path:polygon(0 65%,100% 65%,100% 100%,0 100%);opacity:.7;animation:glitchBot 4s infinite;}
@keyframes glitchAnim{0%,90%,100%{transform:translate3d(0,0,0)}91%{transform:skewX(-1deg) translate3d(0,0,0)}93%{transform:translate3d(2px,0,0) skewX(1deg)}95%{transform:translate3d(0,0,0)}97%{transform:skewX(-0.5deg) translate3d(0,0,0)}}
@keyframes glitchTop{0%,85%,100%{opacity:0;transform:translate3d(0,0,0)}86%,87%{opacity:.8;transform:translate3d(-3px,0,0)}88%,89%{opacity:.6;transform:translate3d(3px,0,0)}}
@keyframes glitchBot{0%,78%,100%{opacity:0;transform:translate3d(0,0,0)}79%,80%{opacity:.8;transform:translate3d(3px,0,0)}81%,82%{opacity:.6;transform:translate3d(-3px,0,0)}}

/* MENU BOX */
.menu-box{background:var(--panel);border:1px solid var(--border);border-top:2px solid var(--red);border-bottom:2px solid var(--red);padding:32px 36px;width:min(580px,95vw);text-align:center;box-shadow:0 0 40px rgba(200,0,0,0.15),0 0 80px rgba(200,0,0,0.05),inset 0 0 30px rgba(0,0,0,0.5);position:relative;max-height:90vh;overflow-y:auto;}
.menu-box::before,.menu-box::after{content:'';position:absolute;width:12px;height:12px;border-color:var(--red);border-style:solid;}
.menu-box::before{top:-1px;left:-1px;border-width:2px 0 0 2px;}
.menu-box::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0;}

/* INPUTS */
.fnaf-input{background:#000;border:1px solid #333;border-bottom:1px solid var(--red);color:var(--green);padding:12px 16px;font-family:var(--mono);font-size:14px;width:100%;outline:none;transition:border-color .2s,box-shadow .2s;letter-spacing:1px;}
.fnaf-input:focus{border-color:var(--red);box-shadow:0 0 12px rgba(255,0,0,0.2);color:#fff;}
.fnaf-input::placeholder{color:#333;}

/* BUTTONS */
.btn{font-family:var(--hud);font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;border:1px solid #444;padding:12px 20px;cursor:pointer;transition:background .15s,color .15s,border-color .15s,box-shadow .15s;width:100%;margin:4px 0;position:relative;overflow:hidden;background:#111;color:#ccc;}
.btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.04),transparent);transform:translateX(-110%);transition:transform .35s;pointer-events:none;}
.btn:hover::before{transform:translateX(110%);}
.btn:hover:not(:disabled){background:#1a1a1a;color:#fff;border-color:var(--red);}
.btn:active:not(:disabled){transform:scale(.99);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-red{background:rgba(100,0,0,.4);color:#ff9999;border:1px solid var(--red);box-shadow:inset 0 0 15px rgba(200,0,0,.2),0 0 8px rgba(200,0,0,.1);font-weight:900;}
.btn-red:hover:not(:disabled){background:rgba(160,0,0,.6);box-shadow:inset 0 0 20px rgba(255,0,0,.3),0 0 15px rgba(255,0,0,.2);color:#fff;}
.btn-green{background:rgba(0,50,0,.5);color:#88ff88;border:1px solid var(--green-dim);box-shadow:inset 0 0 15px rgba(0,200,0,.1),0 0 8px rgba(0,200,0,.05);font-weight:900;}
.btn-green:hover:not(:disabled){background:rgba(0,80,0,.6);color:var(--green);box-shadow:inset 0 0 20px rgba(0,255,0,.15),0 0 12px var(--green-glow);}
.btn-gold{background:rgba(60,40,0,.5);color:var(--gold);border:1px solid #775500;font-weight:900;}
.btn-gold:hover:not(:disabled){background:rgba(80,55,0,.7);box-shadow:0 0 12px var(--gold-glow);}
.btn-purple{background:rgba(50,0,80,.5);color:#cc88ff;border:1px solid #660099;font-weight:900;}
.btn-purple:hover:not(:disabled){background:rgba(80,0,120,.6);box-shadow:0 0 12px var(--purple-glow);color:#fff;}
.btn-tiny{background:rgba(20,20,20,.9);color:#555;border:1px solid #2a2a2a;padding:5px 10px;font-size:9px;font-family:var(--hud);letter-spacing:1px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;margin:2px;width:auto;}
.btn-tiny:hover{color:#fff;border-color:var(--red);}

/* STATUS */
#conn-status{position:fixed;top:10px;right:12px;font-family:var(--hud);font-size:9px;letter-spacing:1.5px;color:#333;z-index:4000;background:rgba(0,0,0,.8);padding:5px 10px;border-radius:3px;border:1px solid #1a1a1a;display:flex;align-items:center;gap:6px;}
#conn-status::before{content:'‚óè';font-size:8px;}
.status-online{color:var(--green)!important;}
.status-online::before{color:var(--green);}
.status-offline{color:var(--red-bright)!important;}
.status-offline::before{color:var(--red-bright);}

/* TOP CONTROLS ‚Äî hidden during match */
#top-left-ctrl{position:fixed;top:10px;left:10px;z-index:3000;display:none;gap:4px;flex-wrap:wrap;}

/* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;font-family:var(--hud);}
.overlay.open{display:flex;}
.overlay-title{font-size:1.4rem;font-weight:900;letter-spacing:3px;text-transform:uppercase;}
.spinner{width:50px;height:50px;border:3px solid #111;border-top-color:var(--red);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

.login-sub{font-family:var(--hud);font-size:9px;letter-spacing:3px;color:#444;text-transform:uppercase;margin-bottom:24px;}
.section-title-bar{font-family:var(--hud);font-size:10px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin:20px 0 10px;display:flex;align-items:center;gap:10px;}
.section-title-bar::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,#222,transparent);}

.data-list{background:#000;border:1px solid #1a1a1a;max-height:200px;overflow-y:auto;margin-bottom:12px;scrollbar-width:thin;scrollbar-color:#330000 #000;}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #0d0d0d;font-size:12px;transition:background .1s;}
.list-item:hover{background:#0a0a0a;}

#reconnect-prompt{display:none;background:rgba(0,30,0,.5);border:1px solid var(--green-dim);padding:16px;margin-bottom:16px;box-shadow:0 0 14px rgba(0,200,0,.18);animation:pulse-opacity 2s ease infinite;}
@keyframes pulse-opacity{0%,100%{opacity:1}50%{opacity:.7}}

/* EDITOR */
#screen-editor{display:none;flex-direction:column;position:fixed;inset:0;z-index:100;background:var(--bg);}
#screen-editor.active{display:flex;}
.editor-topbar{background:var(--panel);border-bottom:2px solid var(--red);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-shrink:0;box-shadow:0 2px 20px rgba(200,0,0,.15);}
.editor-title{font-family:var(--hud);font-size:13px;font-weight:900;letter-spacing:3px;color:var(--red-bright);}
.editor-search-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 20px;background:rgba(0,0,0,.5);border-bottom:1px solid #111;flex-shrink:0;}
.search-input{background:#000;border:1px solid #222;border-bottom-color:var(--red);color:var(--green);padding:7px 12px;font-family:var(--mono);font-size:12px;outline:none;flex:1;min-width:160px;}
.search-input:focus{border-bottom-color:var(--green);color:#fff;}
.jump-select{background:#0a0a0a;border:1px solid #222;color:#aaa;padding:7px 10px;font-family:var(--mono);font-size:11px;cursor:pointer;outline:none;}
.jump-select option{background:#0a0a0a;}
#editor-scroll{flex:1;overflow-y:auto;padding:20px;}
.section-group{margin-bottom:24px;border:1px solid #111;background:rgba(5,5,5,.8);}
.section-header{display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(100,0,0,.08);border-bottom:1px solid #1a1a1a;}
.section-name{font-family:var(--hud);font-size:10px;letter-spacing:3px;color:var(--red);font-weight:700;flex:1;text-transform:uppercase;}
.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;padding:12px;}
.editor-card{width:100%;aspect-ratio:3/4;background:#0d0d0d;border:1px solid #222;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:8px 6px;cursor:cell;transition:all .1s;position:relative;overflow:hidden;}
.editor-card::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent 60%,rgba(0,0,0,.6) 100%);z-index:1;pointer-events:none;}
.editor-card img{width:80%;aspect-ratio:1;object-fit:contain;z-index:0;}
.editor-card .card-name-tag{font-size:9px;text-align:center;font-family:var(--hud);letter-spacing:.5px;font-weight:700;z-index:2;color:#aaa;text-transform:uppercase;}
.editor-card.enabled{border-color:var(--green-dim);background:rgba(0,15,0,.8);box-shadow:inset 0 0 20px rgba(0,255,0,.04),0 0 8px rgba(0,200,0,.08);}
.editor-card.enabled .card-name-tag{color:var(--green);}
.editor-card.disabled{opacity:.25;filter:grayscale(.8);}
.editor-card:hover{border-color:var(--red);transform:scale(1.03) translateZ(0);z-index:5;}
.editor-card.enabled::after{content:'‚úì';position:absolute;top:4px;right:6px;font-size:11px;color:var(--green);font-family:sans-serif;z-index:3;text-shadow:0 0 6px var(--green);}
.editor-bottombar{padding:12px 20px;background:var(--panel);border-top:1px solid #1a1a1a;display:flex;justify-content:center;gap:10px;flex-shrink:0;}
.editor-bottombar .btn{width:auto;padding:10px 22px;font-size:10px;}

/* GAME UI */
#game-ui{display:none;position:fixed;inset:0;z-index:100;background:var(--bg);}

/* LEFT PANEL */
#target-panel{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--panel);border-right:1px solid var(--border);z-index:10;display:flex;flex-direction:column;overflow-y:auto;box-shadow:4px 0 20px rgba(0,0,0,.5);}
.panel-header{background:rgba(100,0,0,.12);border-bottom:2px solid var(--red);padding:14px 16px;flex-shrink:0;}
.panel-user{font-family:var(--hud);font-size:10px;letter-spacing:2px;color:var(--green);margin-bottom:4px;}
.panel-role-badge{display:inline-block;font-family:var(--hud);font-size:8px;letter-spacing:2px;padding:2px 8px;border-radius:2px;margin-bottom:6px;}
.role-player{background:rgba(200,0,0,.3);color:#ff6666;border:1px solid var(--red);}
.role-spectator{background:rgba(100,0,180,.3);color:#cc88ff;border:1px solid #660099;}
.panel-status{font-family:var(--hud);font-size:9px;letter-spacing:1px;color:#ffd700;text-transform:uppercase;opacity:.7;}

#target-display{margin:12px;background:#000;border:1px solid #1a1a1a;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;position:relative;overflow:hidden;}
#target-display img{width:140px;height:140px;object-fit:contain;}
#target-display .target-name{font-family:var(--hud);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--red-bright);margin-top:8px;text-align:center;text-transform:uppercase;}
#target-display .target-label{font-size:9px;color:#444;letter-spacing:2px;margin-bottom:6px;font-family:var(--hud);}

.panel-section{padding:10px 12px;border-top:1px solid #111;flex-shrink:0;}
.panel-section-title{font-family:var(--hud);font-size:8px;letter-spacing:2px;color:#333;margin-bottom:8px;text-transform:uppercase;}
.history-row{display:flex;gap:6px;}
.history-row .btn-tiny{flex:1;text-align:center;}
#volume-slider{width:100%;accent-color:var(--red);cursor:pointer;margin-top:4px;}
.match-search-wrap{padding:8px 12px;border-top:1px solid #111;flex-shrink:0;}
#invert-btn{display:none;}

/* ZOOM CONTROLS */
.zoom-row{display:flex;align-items:center;gap:6px;}
.zoom-row .btn-tiny{font-size:12px;padding:4px 10px;}
#zoom-label{font-family:var(--hud);font-size:9px;color:#555;min-width:32px;text-align:center;}

/* BOARD WRAPPER */
#board-wrapper{position:fixed;left:260px;top:0;right:0;bottom:0;overflow-y:auto;padding:16px;}

/* SPECTATOR: split view */
#board-wrapper.spectator-mode{display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0;}
.spectator-half{overflow-y:auto;padding:12px;border-right:1px solid #1a1a1a;}
.spectator-half:last-child{border-right:none;}
.spectator-header{font-family:var(--hud);font-size:10px;letter-spacing:3px;padding:10px 14px;background:rgba(0,0,0,.6);border-bottom:1px solid #1a1a1a;position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:8px;}
.spectator-header.p1{color:var(--green);border-bottom-color:var(--green-dim);}
.spectator-header.p2{color:#ff6666;border-bottom-color:var(--red);}

/* BOARD SECTIONS */
.board-section-group{margin-bottom:20px;border:1px solid #0d0d0d;background:rgba(3,3,3,.6);}
.board-section-header{display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(50,0,0,.2);border-bottom:1px solid #1a1a1a;}
.board-section-title{font-family:var(--hud);font-size:9px;letter-spacing:3px;color:var(--red);font-weight:700;flex:1;text-transform:uppercase;}

/* BOARD GRID ‚Äî zoom controlled via CSS var */
.board-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--card-min,120px),1fr));gap:8px;padding:10px;}

/* GAME CARD */
.card{width:100%;aspect-ratio:3/4;perspective:800px;cursor:pointer;isolation:isolate;}
.card-inner{width:100%;height:100%;position:relative;transition:transform .45s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d;will-change:transform;}
.card.flipped .card-inner{transform:rotateY(180deg);}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;border-radius:4px;border:1px solid #222;overflow:hidden;}
.card-front{background:#0d0d0d;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:8px 6px;}
.card-front:hover{border-color:#444;}
.card-front img{width:78%;aspect-ratio:1;object-fit:contain;}
.card-front .card-label{font-size:8px;font-family:var(--hud);font-weight:700;letter-spacing:.5px;text-align:center;color:#888;text-transform:uppercase;}
.card-btn-row{display:flex;gap:3px;width:100%;}
.card-action-btn{flex:1;background:#000;border:1px solid #222;color:#555;font-family:var(--hud);font-size:7px;font-weight:700;letter-spacing:.5px;padding:4px 2px;cursor:pointer;transition:background .1s,color .1s,border-color .1s,box-shadow .1s;text-transform:uppercase;}
.card-action-btn.choose-btn{border-color:#440000;color:#993333;}
.card-action-btn.choose-btn:hover{background:#220000;color:#ff6666;border-color:var(--red);box-shadow:0 0 8px rgba(255,0,0,.15);}
.card-action-btn.guess-btn{border-color:#003300;color:#336633;}
.card-action-btn.guess-btn:hover{background:#002200;color:var(--green);border-color:var(--green-dim);box-shadow:0 0 8px var(--green-glow);}
.card-back{background:repeating-linear-gradient(45deg,#1a0000 0px,#1a0000 10px,#110000 10px,#110000 20px);transform:rotateY(180deg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;border-color:var(--red);box-shadow:inset 0 0 20px rgba(200,0,0,.2);}
.card-back .out-text{font-family:var(--hud);font-size:11px;font-weight:900;letter-spacing:3px;color:var(--red-bright);text-shadow:0 0 10px var(--red-glow);}
.card-back::before{content:'‚úï';font-size:2rem;color:rgba(200,0,0,.3);}
/* Hover: only translate Z-axis (depth) ‚Äî never X/Y which shifts siblings */
.card:not(.flipped):hover .card-inner{transform:translateZ(6px) scale(1.02);}

/* Spectator cards ‚Äî no buttons, no click feedback */
.spectator-mode .card{cursor:default;}
.spectator-mode .card:not(.flipped):hover .card-front{transform:none;box-shadow:none;}
.spectator-mode .card-front:hover{border-color:#222;}

.highlight-action{outline:2px solid var(--green)!important;outline-offset:3px;z-index:50;animation:highlightPulse .8s ease;}
@keyframes highlightPulse{0%{outline-color:var(--green);box-shadow:0 0 20px var(--green-glow)}100%{outline-color:transparent;box-shadow:none}}

/* GAME OVER */
.end-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;}
.end-side{background:#050505;border:1px solid #1a1a1a;padding:14px;text-align:center;}
.end-img{width:100px;height:100px;object-fit:contain;margin:10px auto;display:block;filter:drop-shadow(0 0 10px rgba(255,0,0,.3));}
.result-text{font-family:var(--title);font-size:3rem;letter-spacing:4px;margin-bottom:10px;animation:resultPulse 1.5s ease infinite;}
@keyframes resultPulse{0%,100%{filter:drop-shadow(0 0 8px currentColor)}50%{filter:drop-shadow(0 0 28px currentColor)}}

/* TOOLTIP */
[data-tip]{position:relative;}
[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:#111;color:var(--green);font-family:var(--mono);font-size:10px;padding:4px 8px;border:1px solid #333;white-space:nowrap;z-index:999;pointer-events:none;}

/* COUNT BADGE */
.count-badge{background:rgba(100,0,0,.3);color:#ff6666;font-family:var(--hud);font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 8px;border:1px solid #440000;display:inline-block;vertical-align:middle;}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:#000;}
::-webkit-scrollbar-thumb{background:#330000;border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--red);}

#bottom-left-ctrl{position:fixed;bottom:12px;left:12px;z-index:3000;}

/* LOBBY */
.lobby-player-row{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid #0d0d0d;}
.lobby-player-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);flex-shrink:0;}
.lobby-player-name{font-size:13px;font-weight:bold;flex:1;}
.lobby-badge{font-family:var(--hud);font-size:8px;letter-spacing:1px;padding:1px 6px;margin-left:3px;}
.badge-host{color:var(--red-bright);border:1px solid var(--red);}
.badge-player{color:var(--green);border:1px solid var(--green-dim);}
.badge-spectator{color:#cc88ff;border:1px solid #660099;}
.role-select{background:#111;border:1px solid #333;color:#aaa;font-family:var(--hud);font-size:9px;padding:2px 5px;cursor:pointer;margin-left:4px;}
.role-select:focus{outline:none;border-color:var(--red);}

/* SPECTATOR INFO PANEL */
#spectator-info{padding:12px;border-top:1px solid #111;flex-shrink:0;}
.spectator-legend{font-family:var(--hud);font-size:8px;letter-spacing:1px;color:#555;margin-bottom:8px;text-transform:uppercase;}
.spec-player-label{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:10px;font-family:var(--hud);}
.spec-dot-green{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;}
.spec-dot-red{width:8px;height:8px;border-radius:50%;background:var(--red-bright);flex-shrink:0;}
/* Spectator target cards shown in left panel */
.spec-target-row{display:flex;gap:8px;margin-top:10px;}
.spec-target-card{flex:1;background:#000;border:1px solid #1a1a1a;padding:6px;text-align:center;}
.spec-target-card.p1{border-color:var(--green-dim);}
.spec-target-card.p2{border-color:#550000;}
.spec-target-card img{width:100%;aspect-ratio:1;object-fit:contain;display:block;}
.spec-target-label{font-family:var(--hud);font-size:7px;letter-spacing:1px;margin-bottom:4px;padding-bottom:3px;border-bottom:1px solid #111;}
.spec-target-label.p1{color:var(--green);}
.spec-target-label.p2{color:#ff6666;}
.spec-target-name{font-family:var(--hud);font-size:7px;color:#aaa;margin-top:3px;letter-spacing:.5px;}
.spec-target-waiting{font-family:var(--hud);font-size:8px;color:#333;letter-spacing:1px;padding:10px 0;}

@media(max-width:600px){
  #target-panel{width:200px;}
  #board-wrapper{left:200px;}
  .board-grid{grid-template-columns:repeat(auto-fill,minmax(var(--card-min,90px),1fr));}
  #board-wrapper.spectator-mode{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="bg-layer"></div>
<audio id="bg-audio" loop><source src="background-music.mp3" type="audio/mpeg"></audio>
<audio id="sfx-btn"><source src="button.mp3" type="audio/mpeg"></audio>

<div id="conn-status">PEER: DISCONNECTED</div>

<!-- OVERLAYS -->
<div class="overlay" id="sync-overlay">
  <div class="spinner"></div>
  <div class="overlay-title" style="color:var(--green)">SYNCING...</div>
  <div style="font-size:11px;color:#555;letter-spacing:2px;">WAITING FOR OPPONENT TO CHOOSE THEIR ANIMATRONIC</div>
</div>
<div class="overlay" id="pause-overlay">
  <div style="font-size:3rem;margin-bottom:10px">‚ö†</div>
  <div class="overlay-title" style="color:var(--gold)">CONNECTION LOST</div>
  <div id="pause-msg" style="font-size:11px;color:#666;letter-spacing:2px;text-align:center;margin-top:10px;max-width:400px;"></div>
  <div class="spinner" style="margin-top:20px;border-top-color:var(--gold)"></div>
  <button class="btn btn-gold" style="width:auto;padding:10px 24px;margin-top:10px;" onclick="attemptReconnect()">‚Ü∫ RETRY CONNECTION</button>
</div>

<!-- TOP CONTROLS ‚Äî hidden during active match -->
<div id="top-left-ctrl" style="display:none;gap:4px;flex-wrap:wrap;">
  <button id="logout-btn" class="btn-tiny" onclick="logout()">‚èª LOGOUT</button>
</div>
<div id="bottom-left-ctrl">
  <button class="btn-tiny" style="color:#330000;" onclick="factoryReset()">‚ö† FACTORY RESET</button>
</div>

<!-- LOGIN -->
<div id="screen-login" class="screen active">
  <div class="menu-box">
    <div class="glitch-title" data-text="FNAF GUESS WHO" style="margin-bottom:6px;">FNAF GUESS WHO</div>
    <div class="login-sub">ENTER YOUR OPERATIVE DESIGNATION</div>
    <input type="text" id="username-input" class="fnaf-input" placeholder="USERNAME" maxlength="20" style="text-align:center;letter-spacing:3px;margin-bottom:12px;" onkeydown="if(event.key==='Enter')confirmLogin()">
    <button class="btn btn-red" onclick="confirmLogin()">‚ñ∂ ENTER TERMINAL</button>
  </div>
</div>

<!-- MAIN MENU -->
<div id="screen-main" class="screen">
  <div class="menu-box">
    <div class="glitch-title" data-text="FNAF GUESS WHO" style="font-size:2.2rem;margin-bottom:4px;">FNAF GUESS WHO</div>
    <div id="welcome-msg" style="font-family:var(--hud);font-size:10px;letter-spacing:3px;color:var(--green);margin-bottom:24px;"></div>
    <div id="reconnect-prompt">
      <div id="resume-text" style="font-size:11px;color:#aaa;margin-bottom:10px;letter-spacing:1px;"></div>
      <button class="btn btn-green" onclick="resumeSession()" style="margin-bottom:4px;">‚ü≥ RESUME MATCH</button>
      <button class="btn" style="font-size:9px;height:28px;padding:0;" onclick="clearSession()">DISCARD SESSION</button>
    </div>
    <div class="section-title-bar">MULTIPLAYER</div>
    <button class="btn btn-red" onclick="showScreen('screen-join')">‚ö° JOIN ROOM</button>
    <button class="btn btn-red" onclick="hostRoom()">‚òÖ HOST ROOM</button>
    <div class="section-title-bar">MANAGEMENT</div>
    <button class="btn" onclick="openBoardManager()">üìã BOARDS EDITOR</button>
    <div class="section-title-bar">ACCOUNT</div>
    <button class="btn" onclick="logout()">‚èª LOGOUT</button>
  </div>
</div>

<!-- JOIN ROOM -->
<div id="screen-join" class="screen">
  <div class="menu-box">
    <div style="font-family:var(--hud);font-size:1rem;font-weight:900;letter-spacing:4px;color:var(--red-bright);margin-bottom:6px;">JOIN ROOM</div>
    <div style="font-size:10px;color:#444;margin-bottom:20px;letter-spacing:1px;">ENTER HOST USERNAME ‚Äî NOT CASE SENSITIVE</div>
    <input type="text" id="join-room-id" class="fnaf-input" placeholder="HOST USERNAME" style="text-align:center;letter-spacing:2px;margin-bottom:12px;" onkeydown="if(event.key==='Enter')connectToPeer()">
    <button class="btn btn-green" onclick="connectToPeer()">‚ñ∂ CONNECT</button>
    <button class="btn" onclick="showScreen('screen-main')">‚Üê BACK</button>
  </div>
</div>

<!-- LOBBY -->
<div id="screen-lobby" class="screen">
  <div class="menu-box" style="max-width:640px;">
    <div id="lobby-title" style="font-family:var(--hud);font-size:.9rem;font-weight:900;letter-spacing:3px;color:var(--red-bright);margin-bottom:16px;"></div>
    <div class="section-title-bar">CONNECTED PLAYERS</div>
    <div id="player-roster" class="data-list" style="max-height:260px;"></div>
    <div id="host-controls" style="display:none;">
      <div class="section-title-bar">SELECT BOARD</div>
      <select id="lobby-board-select" class="fnaf-input" style="margin-bottom:12px;color:#aaa;"></select>
      <div style="font-size:10px;color:#555;margin-bottom:8px;letter-spacing:1px;">Assign roles above, then start. Exactly 2 players required.</div>
      <button class="btn btn-gold" id="start-btn" onclick="signalStart()">‚ö° START MATCH</button>
    </div>
    <div id="guest-waiting" style="display:none;font-family:var(--hud);font-size:9px;letter-spacing:2px;color:#444;margin:16px 0;animation:blink-status 1.5s infinite;">‚óè WAITING FOR HOST TO START...</div>
    <div id="my-role-display" style="display:none;font-family:var(--hud);font-size:10px;margin:10px 0;padding:8px;border:1px solid #222;"></div>
    <button class="btn" onclick="disconnect()">‚èª DISCONNECT</button>
  </div>
</div>

<!-- BOARDS MANAGER -->
<div id="screen-boards" class="screen">
  <div class="menu-box">
    <div style="font-family:var(--hud);font-size:1rem;font-weight:900;letter-spacing:4px;color:var(--red-bright);margin-bottom:16px;">YOUR BOARDS</div>
    <div id="board-list" class="data-list" style="max-height:240px;"></div>
    <input type="text" id="new-board-name" class="fnaf-input" placeholder="NEW BOARD NAME" style="margin-bottom:8px;">
    <button class="btn btn-green" onclick="createNewBoard()">+ CREATE NEW BOARD</button>
    <button class="btn" onclick="showScreen('screen-main')">‚Üê BACK</button>
  </div>
</div>

<!-- EDITOR -->
<div id="screen-editor" class="screen">
  <div class="editor-topbar">
    <div class="editor-title">‚öô BOARD EDITOR ‚Äî <span id="editing-title" style="color:#aaa;"></span></div>
    <div style="display:flex;gap:6px;align-items:center;">
      <span id="editor-count" class="count-badge">0 ENABLED</span>
      <button class="btn-tiny" onclick="saveEditor()">üíæ SAVE</button>
      <button class="btn-tiny" onclick="openBoardManager()">‚úï CLOSE</button>
    </div>
  </div>
  <div class="editor-search-row">
    <input type="text" id="editor-search" class="search-input" placeholder="SEARCH ANIMATRONIC..." oninput="renderVisualEditor()">
    <select id="section-jump" class="jump-select" onchange="jumpToSection(this.value,'editor-scroll')">
      <option value="">JUMP TO GAME...</option>
      <option value="fnaf1">FNAF 1</option><option value="fnaf2">FNAF 2</option>
      <option value="fnaf3">FNAF 3</option><option value="fnaf4">FNAF 4</option>
      <option value="sl">SISTER LOCATION</option><option value="ffps">PIZZERIA SIM</option>
      <option value="sb">SECURITY BREACH</option><option value="hw">HELP WANTED 1/2</option>
      <option value="other">UCN / OTHER</option>
    </select>
  </div>
  <div id="editor-scroll"><div id="editor-grid"></div></div>
  <div class="editor-bottombar">
    <button class="btn btn-red" style="font-size:9px;" onclick="bulkToggle(true)">‚òë SELECT ALL</button>
    <button class="btn btn-red" style="font-size:9px;" onclick="bulkToggle(false)">‚òê DESELECT ALL</button>
    <button class="btn btn-green" onclick="saveEditor()">üíæ SAVE BOARD</button>
  </div>
</div>

<!-- GAME OVER -->
<div id="screen-game-over" class="screen">
  <div class="menu-box" style="max-width:700px;width:95vw;">
    <div id="end-result-banner" class="result-text"></div>
    <div class="end-grid">
      <div class="end-side">
        <div style="font-family:var(--hud);font-size:9px;color:#444;letter-spacing:2px;margin-bottom:8px;">FINAL GUESS BY <span id="end-guesser-name" style="color:var(--green);"></span></div>
        <img id="end-guess-img" class="end-img" src="">
        <div id="end-guess-name" style="font-family:var(--hud);font-size:11px;font-weight:700;color:#ccc;letter-spacing:1px;margin-top:4px;"></div>
      </div>
      <div class="end-side">
        <div style="font-family:var(--hud);font-size:9px;color:#444;letter-spacing:2px;margin-bottom:8px;">ACTUAL TARGETS</div>
        <div style="display:flex;justify-content:space-around;gap:10px;">
          <div>
            <div style="font-family:var(--hud);font-size:8px;color:var(--green);letter-spacing:1px;margin-bottom:4px;">P1</div>
            <img id="end-p1-img" style="width:70px;height:70px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(0,255,0,.2));">
            <div id="end-p1-name" style="font-family:var(--hud);font-size:9px;color:#aaa;margin-top:4px;"></div>
          </div>
          <div>
            <div style="font-family:var(--hud);font-size:8px;color:var(--red-bright);letter-spacing:1px;margin-bottom:4px;">P2</div>
            <img id="end-p2-img" style="width:70px;height:70px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,0,0,.2));">
            <div id="end-p2-name" style="font-family:var(--hud);font-size:9px;color:#aaa;margin-top:4px;"></div>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn-red" style="margin-top:10px;" onclick="showScreen('screen-lobby')">‚Ü© BACK TO LOBBY</button>
  </div>
</div>

<!-- GAME UI -->
<div id="game-ui">
  <div id="target-panel">
    <div class="panel-header">
      <div class="panel-user" id="user-tag">---</div>
      <div id="role-badge" class="panel-role-badge role-player">‚óè PLAYER</div>
      <div class="panel-status" id="game-status">SELECT YOUR ANIMATRONIC</div>
    </div>
    <div id="target-display">
      <div style="font-family:var(--hud);font-size:9px;letter-spacing:2px;color:#222;">AWAITING SELECTION</div>
    </div>
    <div class="panel-section" id="history-section">
      <div class="panel-section-title">HISTORY</div>
      <div class="history-row">
        <button id="undo-btn" class="btn-tiny" onclick="undo()" disabled data-tip="Undo last flip">‚üµ UNDO</button>
        <button id="redo-btn" class="btn-tiny" onclick="redo()" disabled data-tip="Redo">REDO ‚ü∂</button>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">SYSTEM VOLUME</div>
      <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.2" oninput="updateVolume(this.value)">
    </div>
    <div class="panel-section">
      <div class="panel-section-title">CARD ZOOM</div>
      <div class="zoom-row">
        <button class="btn-tiny" onclick="changeZoom(-10)">Ôºç</button>
        <div id="zoom-label">120px</div>
        <button class="btn-tiny" onclick="changeZoom(10)">Ôºã</button>
      </div>
    </div>
    <div class="match-search-wrap">
      <div class="panel-section-title">SEARCH BOARD</div>
      <input type="text" id="match-search" class="search-input" style="width:100%;" placeholder="SEARCH..." oninput="refreshMatchBoard()">
      <select id="match-jump" class="jump-select" style="width:100%;margin-top:6px;" onchange="jumpToSection(this.value,'board-wrapper')">
        <option value="">JUMP TO SECTION...</option>
      </select>
    </div>
    <div class="panel-section">
      <button id="invert-btn" class="btn btn-gold" style="font-size:9px;width:100%;" onclick="invertFlippedCards()">‚áÑ INVERT FLIPPED</button>
    </div>
    <!-- Spectator info shown instead of target for spectators -->
    <div id="spectator-info" style="display:none;">
      <div class="spectator-legend">SPECTATING</div>
      <div class="spec-player-label"><div class="spec-dot-green"></div><span id="spec-p1-name">Player 1</span> ‚Äî LEFT</div>
      <div class="spec-player-label"><div class="spec-dot-red"></div><span id="spec-p2-name">Player 2</span> ‚Äî RIGHT</div>
      <div class="spectator-legend" style="margin-top:12px;">SECRET ANIMATRONICS</div>
      <div class="spec-target-row">
        <div class="spec-target-card p1" id="spec-target-p1">
          <div class="spec-target-label p1" id="spec-target-p1-label">P1</div>
          <div class="spec-target-waiting" id="spec-target-p1-waiting">CHOOSING...</div>
          <img id="spec-target-p1-img" style="display:none;" onerror="this.style.display='none'">
          <div class="spec-target-name" id="spec-target-p1-name"></div>
        </div>
        <div class="spec-target-card p2" id="spec-target-p2">
          <div class="spec-target-label p2" id="spec-target-p2-label">P2</div>
          <div class="spec-target-waiting" id="spec-target-p2-waiting">CHOOSING...</div>
          <img id="spec-target-p2-img" style="display:none;" onerror="this.style.display='none'">
          <div class="spec-target-name" id="spec-target-p2-name"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="board-wrapper"><div id="game-board"></div></div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const categories=[
  {id:"fnaf1",title:"FNAF 1",range:[0,8]},{id:"fnaf2",title:"FNAF 2",range:[9,23]},
  {id:"fnaf3",title:"FNAF 3",range:[24,30]},{id:"fnaf4",title:"FNAF 4",range:[31,44]},
  {id:"sl",title:"SISTER LOCATION",range:[45,58]},{id:"ffps",title:"PIZZERIA SIM",range:[59,77]},
  {id:"other",title:"UCN / OTHER",range:[78,82]},{id:"sb",title:"SECURITY BREACH",range:[83,96]},
  {id:"hw",title:"HELP WANTED 1/2",range:[97,102]}
];
const animData=[
  {name:"Freddy Fazbear",img:"Freddy Fazbear.webp"},{name:"Bonnie",img:"Bonnie.webp"},{name:"Chica",img:"Chica.webp"},{name:"Foxy",img:"Foxy.webp"},{name:"Golden Freddy",img:"Golden Freddy.webp"},{name:"Phone Guy",img:"Phone Guy.webp"},{name:"Mr. Cupcake",img:"Mr. Cupcake.webp"},{name:"Desk Fan",img:"Desk Fan.webp"},{name:"Endo-01",img:"Endo-01.webp"},
  {name:"Toy Freddy",img:"Toy Freddy.webp"},{name:"Toy Bonnie",img:"Toy Bonnie.webp"},{name:"Toy Chica",img:"Toy Chica.webp"},{name:"Toy Mangle",img:"Toy Mangle.webp"},{name:"Toy Cupcake",img:"Toy Cupcake.webp"},{name:"Balloon Boy",img:"Balloon Boy.webp"},{name:"Jay Jay",img:"Jay Jay.webp"},{name:"Marionette",img:"Marionette.webp"},{name:"Withered Freddy",img:"Withered Freddy.webp"},{name:"Withered Bonnie",img:"Withered Bonnie.webp"},{name:"Withered Chica",img:"Withered Chica.webp"},{name:"Withered Foxy",img:"Withered Foxy.webp"},{name:"Shadow Freddy",img:"Shadow Freddy.webp"},{name:"Shadow Bonnie",img:"Shadow Bonnie.webp"},{name:"Endo-02",img:"Endo-02.webp"},
  {name:"Springtrap",img:"Springtrap.webp"},{name:"Phantom Freddy",img:"Phantom Freddy.webp"},{name:"Phantom Chica",img:"Phantom Chica.webp"},{name:"Phantom Foxy",img:"Phantom Foxy.webp"},{name:"Phantom Mangle",img:"Phantom Mangle.webp"},{name:"Phantom Balloon Boy",img:"Phantom Balloon Boy.webp"},{name:"Phantom Puppet",img:"Phantom Puppet.webp"},
  {name:"Nightmare Freddy",img:"Nightmare Freddy.webp"},{name:"Nightmare Bonnie",img:"Nightmare Bonnie.webp"},{name:"Nightmare Chica",img:"Nightmare Chica.webp"},{name:"Nightmare Foxy",img:"Nightmare Foxy.webp"},{name:"Nightmare Fredbear",img:"Nightmare Fredbear.webp"},{name:"Nightmare",img:"Nightmare.webp"},{name:"Plushtrap",img:"Plushtrap.webp"},{name:"Freddles",img:"Freddles.webp"},{name:"Nightmare Cupcake",img:"Nightmare Cupcake.webp"},{name:"Jack-O-Bonnie",img:"Jack-O-Bonnie.webp"},{name:"Jack-O-Chica",img:"Jack-O-Chica.webp"},{name:"Nightmare Mangle",img:"Nightmare Mangle.webp"},{name:"Nightmarionne",img:"Nightmarionne.webp"},{name:"Nightmare Balloon Boy",img:"Nightmare Balloon Boy.webp"},
  {name:"Circus Baby",img:"Circus Baby.webp"},{name:"Ballora",img:"Ballora.webp"},{name:"Funtime Freddy",img:"Funtime Freddy.webp"},{name:"Funtime Foxy",img:"Funtime Foxy.webp"},{name:"Ennard",img:"Ennard.webp"},{name:"Bidybab",img:"Bidybab.webp"},{name:"Minireenas",img:"Minireenas.webp"},{name:"Bon-Bon",img:"Bon-Bon.webp"},{name:"Bonnet",img:"Bonnet.webp"},{name:"Lolbit",img:"Lolbit.webp"},{name:"Yenndo",img:"Yenndo.webp"},{name:"Funtime Cupcake",img:"Funtime Cupcake.webp"},{name:"Casual Bongos",img:"Casual Bongos.webp"},{name:"Exotic Butters",img:"Exotic Butters.webp"},
  {name:"Helpy",img:"Helpy.webp"},{name:"Scrap Baby",img:"Scrap Baby.webp"},{name:"ScrapTrap",img:"ScrapTrap.webp"},{name:"Molten Freddy",img:"Molten Freddy.webp"},{name:"Lefty",img:"Lefty.webp"},{name:"Rockstar Freddy",img:"Rockstar Freddy.webp"},{name:"Rockstar Bonnie",img:"Rockstar Bonnie.webp"},{name:"Rockstar Chica",img:"Rockstar Chica.webp"},{name:"Rockstar Foxy",img:"Rockstar Foxy.webp"},{name:"Happy Frog",img:"Happy Frog.webp"},{name:"Mr. Hippo",img:"Mr. Hippo.webp"},{name:"Pigpatch",img:"Pigpatch.webp"},{name:"Nedd Bear",img:"Nedd Bear.webp"},{name:"Orville Elephant",img:"Orville Elephant.webp"},{name:"Music Man",img:"Music Man.webp"},{name:"El Chip",img:"El Chip.webp"},{name:"Funtime Chica",img:"Funtime Chica.webp"},{name:"Candy Cadet",img:"Candy Cadet.webp"},{name:"Trash And The Gang",img:"Trash And The Gang.webp"},
  {name:"Dee Dee",img:"Dee Dee.webp"},{name:"Shadow Dee Dee",img:"Shadow Dee Dee.webp"},{name:"Old Man Consequences",img:"Old Man Consequences.webp"},{name:"Fredbear",img:"Fredbear.webp"},{name:"Spring Bonnie",img:"Spring Bonnie.webp"},
  {name:"Glamrock Freddy",img:"Glamrock Freddy.webp"},{name:"Glamrock Chica",img:"Glamrock Chica.webp"},{name:"Montgomery Gator",img:"Montgomery Gator.webp"},{name:"Roxanne Wolf",img:"Roxanne Wolf.webp"},{name:"Daycare Attendant Sun",img:"Daycare Attendant Sun.webp"},{name:"Daycare Attendant Moon",img:"Daycare Attendant Moon.webp"},{name:"Daycare Attendant Eclipse",img:"Daycare Attendant Eclipse.webp"},{name:"Glamrock Bonnie",img:"Glamrock Bonnie.webp"},{name:"Glamrock Endo",img:"Glamrock Endo.webp"},{name:"The Mimic",img:"The Mimic.webp"},{name:"Blob",img:"Blob.webp"},{name:"Faz Wrench",img:"Faz Wrench.webp"},{name:"Vanny",img:"Vanny.webp"},{name:"Vanessa",img:"Vanessa.webp"},
  {name:"Glitchtrap",img:"Glitchtrap.webp"},{name:"Mystic Hippo",img:"Mystic Hippo.webp"},{name:"Carnie",img:"Carnie.webp"},{name:"Grimm Foxy",img:"Grimm Foxy.webp"},{name:"Dreadbear",img:"Dreadbear.webp"},{name:"Plushbabies",img:"Plushbabies.webp"}
];
const masterRoster=animData.map((d,i)=>({id:i,name:d.name,img:`Animatronics/${d.img}`,enabled:true}));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let savedBoards={}, myName=localStorage.getItem('fnaf_user')||"";
let peer=null, conn=null, extraConns=[]; // extraConns = spectators
let isHost=false, roomPlayers=[];
let activeRoster=[], isDragging=false, dragTargetState=null, lastToggledId=null;
let myTargetForOpponent=null, opponentTargetForMe=null, myTargetObj=null;
let currentBoardName="", currentMatchMode="";
let flippedCards=new Set();
let historyStack=[], redoStack=[];
let myRole='player'; // 'player' or 'spectator'
let playerRoles={}; // {name: 'player'|'spectator'} ‚Äî host maintained
let player1Name=null, player2Name=null; // the two actual players
let spectatorBoardStates={}; // {playerName: Set of flipped cards} for spectator view
let spectatorTargets={}; // {playerName: {name, img}} ‚Äî secret targets visible to spectators
let cardZoom=parseInt(localStorage.getItem('fnaf_zoom')||'120');
let reconnectTimer=null;

const peerConfig={
  config:{iceServers:[
    {url:'stun:stun.l.google.com:19302'},
    {url:'stun:stun1.l.google.com:19302'},
    {url:'stun:stun2.l.google.com:19302'}
  ]},
  debug:1
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updatePeerStatus(status,isError=false){
  const el=document.getElementById('conn-status');
  el.innerText=`PEER: ${status.toUpperCase()}`;
  el.className=isError?'status-offline':(status==='connected'?'status-online':'');
}
function playBtnSfx(){const s=document.getElementById('sfx-btn');if(s){s.currentTime=0;s.play().catch(()=>{});}}
document.addEventListener('click',e=>{if(e.target.tagName==='BUTTON'||e.target.closest('button'))playBtnSfx();});
document.addEventListener('click',()=>initAudio(),{once:true});
function initAudio(){
  const a=document.getElementById('bg-audio');
  if(a){const v=localStorage.getItem('fnaf_volume')||0.2;a.volume=v;const s=document.getElementById('volume-slider');if(s)s.value=v;a.play().catch(()=>{});}
}
function updateVolume(val){const a=document.getElementById('bg-audio');if(a){a.volume=val;localStorage.setItem('fnaf_volume',val);}}

/* Hide/show login+logout controls based on match state */
function setInMatchMode(inMatch){
  const ctrl=document.getElementById('top-left-ctrl');
  // During a match: hide top controls entirely (no logout, no menu)
  if(inMatch){ctrl.style.display='none';}
  else{ctrl.style.display=myName?'flex':'none';}
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const sc=document.getElementById(id);
  if(sc)sc.classList.add('active');
  const inGame=(id==='game-ui');
  document.getElementById('game-ui').style.display=inGame?'block':'none';
  document.getElementById('sync-overlay').classList.remove('open');
  document.getElementById('pause-overlay').classList.remove('open');
  setInMatchMode(inGame);
}

function applyZoom(){
  // Set on the wrapper ‚Äî no inline styles on grids so this cascades correctly
  const bw=document.getElementById('board-wrapper');
  if(bw)bw.style.setProperty('--card-min',cardZoom+'px');
  const lbl=document.getElementById('zoom-label');
  if(lbl)lbl.innerText=cardZoom+'px';
  localStorage.setItem('fnaf_zoom',cardZoom);
}
function changeZoom(delta){
  cardZoom=Math.max(60,Math.min(300,cardZoom+delta));
  applyZoom();
  // Re-render immediately so new grid columns take effect right away
  if(myRole==='spectator'){renderSpectatorBoard();}
  else if(currentMatchMode){refreshMatchBoard();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadUserData(){
  if(!myName)return;
  savedBoards=JSON.parse(localStorage.getItem(`fnaf_boards_${myName}`))||{"Main Roster":[...masterRoster]};
}
function saveUserData(){if(!myName)return;localStorage.setItem(`fnaf_boards_${myName}`,JSON.stringify(savedBoards));}

function confirmLogin(){
  const input=document.getElementById('username-input').value.trim();
  if(!input)return;
  myName=input;
  localStorage.setItem('fnaf_user',myName);
  loadUserData();
  initSession();
}
function initSession(){
  document.getElementById('welcome-msg').innerText=`OPERATIVE: ${myName.toUpperCase()}`;
  setInMatchMode(false);
  showScreen('screen-main');
  checkSession();
}
function logout(){
  if(conn||currentMatchMode!==""){if(!confirm("Active game will be lost. Logout?"))return;disconnect(true);}
  localStorage.removeItem('fnaf_user');
  myName="";
  document.getElementById('username-input').value="";
  setInMatchMode(false);
  document.getElementById('top-left-ctrl').style.display='none';
  showScreen('screen-login');
}
window.onload=()=>{
  applyZoom();
  if(myName){loadUserData();initSession();}
};
function factoryReset(){if(confirm("‚ö† WIPE ALL LOCAL DATA?")){{localStorage.clear();location.reload();}}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveSession(){
  if(currentMatchMode===""&&!localStorage.getItem('fnaf_active_session'))return;
  localStorage.setItem('fnaf_active_session',JSON.stringify({
    isHost,activeRoster,myTargetForOpponent,opponentTargetForMe,
    flippedCards:Array.from(flippedCards),myTargetObj,
    hostID:isHost?(peer?peer.id:null):(conn?conn.peer:null),
    mode:currentMatchMode,myRole,player1Name,player2Name
  }));
}
function clearSession(){
  localStorage.removeItem('fnaf_active_session');
  const p=document.getElementById('reconnect-prompt');
  if(p)p.style.display='none';
}
function checkSession(){
  const s=localStorage.getItem('fnaf_active_session');
  if(s){
    const session=JSON.parse(s);
    document.getElementById('reconnect-prompt').style.display='block';
    document.getElementById('resume-text').innerText=session.isHost
      ?"UNFINISHED MATCH DETECTED ‚Äî YOU WERE HOSTING."
      :"UNFINISHED MATCH DETECTED ‚Äî YOU WERE A GUEST.";
  }
}
function resumeSession(){
  const session=JSON.parse(localStorage.getItem('fnaf_active_session'));
  if(!session)return;
  // Pre-load state into variables ‚Äî connection handler will restore display
  isHost=session.isHost;
  activeRoster=session.activeRoster||[];
  myTargetForOpponent=session.myTargetForOpponent||null;
  opponentTargetForMe=session.opponentTargetForMe||null;
  flippedCards=new Set(session.flippedCards||[]);
  myTargetObj=session.myTargetObj||null;
  currentMatchMode=session.mode||'';
  myRole=session.myRole||'player';
  player1Name=session.player1Name||null;
  player2Name=session.player2Name||null;
  const hostID=session.hostID;
  if(isHost){
    hostRoom(hostID);
  } else {
    if(hostID){connectToPeer(hostID);}
    else{clearSession();showScreen('screen-main');}
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveHistory(affectedNames=null){historyStack.push({state:new Set(flippedCards),affected:affectedNames});redoStack=[];updateHistoryButtons();saveSession();}
function undo(){if(!historyStack.length)return;const cur=historyStack.pop();redoStack.push({state:new Set(flippedCards),affected:cur.affected});flippedCards=cur.state;updateHistoryButtons();refreshMatchBoard();saveSession();if(cur.affected)jumpToCard(cur.affected);}
function redo(){if(!redoStack.length)return;const next=redoStack.pop();historyStack.push({state:new Set(flippedCards),affected:next.affected});flippedCards=next.state;updateHistoryButtons();refreshMatchBoard();saveSession();if(next.affected)jumpToCard(next.affected);}
function updateHistoryButtons(){const u=document.getElementById('undo-btn');const r=document.getElementById('redo-btn');if(u)u.disabled=historyStack.length===0;if(r)r.disabled=redoStack.length===0;}
function jumpToCard(names){
  if(!names||!names.length)return;
  const name=Array.isArray(names)?names[0]:names;
  const el=document.querySelector(`.card[data-name="${name}"]`);
  if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.classList.add('highlight-action');setTimeout(()=>el.classList.remove('highlight-action'),1000);}
}
function jumpToSection(catId,scrollContainerId){
  if(!catId)return;
  const target=document.getElementById(`section-${catId}-${scrollContainerId}`);
  if(target)target.scrollIntoView({behavior:'smooth',block:'start'});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BROADCAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function broadcast(data,exclude=null){
  if(isHost){
    // Host sends to all guest connections
    extraConns.forEach(c=>{
      if(c&&c!==exclude&&c.open){try{c.send(data);}catch(e){}}
    });
  } else {
    // Guest sends to host
    if(conn&&conn.open){try{conn.send(data);}catch(e){}}
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NETWORK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function hostRoom(existingID=null){
  if(peer)peer.destroy();
  isHost=true;
  const idToUse=existingID||(myName.replace(/\s+/g,'_').toLowerCase());
  peer=new Peer(idToUse,peerConfig);

  peer.on('open',id=>{
    updatePeerStatus('hosting ('+id+')');
    playerRoles={};
    playerRoles[myName]='player'; // host defaults to player
    roomPlayers=[{name:myName,isHost:true}];
    if(existingID){
      showScreen('game-ui');
      myTargetForOpponent?lockTarget(myTargetForOpponent,myTargetObj.img):renderMatchBoard('choose');
    } else {
      showScreen('screen-lobby');
      document.getElementById('lobby-title').innerText="HOST ID: "+idToUse+" (share this)";
      renderRoster();
    }
  });

  peer.on('error',err=>{
    console.error('Peer Error:',err.type);
    if(err.type==='unavailable-id'){alert("Username already hosting. Try a different name.");logout();}
    updatePeerStatus('Error: '+err.type,true);
  });

  peer.on('connection',c=>{
    updatePeerStatus('guest connecting...');

    c.on('open',()=>{
      // Send current room state immediately
      c.send({type:'WELCOME',hostName:myName,inGame:currentMatchMode!=="",players:roomPlayers.map(p=>({name:p.name,isHost:p.isHost})),roles:playerRoles});
      if(currentMatchMode!==""){
        // New connection mid-game ‚Äî will handle properly after JOIN
      }
    });

    c.on('data',data=>{
      if(data.type==='JOIN'){
        const joiningName=data.name;
        const isReconnect=!!data.reconnecting;

        // Check if this player was already in the room (reconnect case)
        const existingPlayer=roomPlayers.find(p=>p.name===joiningName);

        if(existingPlayer){
          // Reconnect: swap the connection reference
          const oldConn=existingPlayer._conn;
          if(oldConn&&oldConn!==c){
            extraConns=extraConns.filter(x=>x!==oldConn);
            try{oldConn.close();}catch(e){}
          }
          existingPlayer._conn=c;
          existingPlayer._connObj=c;
          // Make sure c is in extraConns
          if(!extraConns.includes(c))extraConns.push(c);
          c._playerName=joiningName;

          // Remove pause overlay
          document.getElementById('pause-overlay').classList.remove('open');
          updatePeerStatus('reconnected');

          // Re-send full game state so guest can resume
          if(currentMatchMode!==""){
            c.send({type:'REJOIN_STATE',
              roster:activeRoster,
              roles:playerRoles,
              player1:player1Name,
              player2:player2Name,
              // Send targets (only the one meant for this player)
              opponentTarget: myTargetForOpponent||null,
              myTarget: null // guest needs to re-send their own
            });
          }
        } else {
          // Brand new player
          roomPlayers.push({name:joiningName,isHost:false,_conn:c});
          if(!playerRoles[joiningName])playerRoles[joiningName]='spectator';
          if(!extraConns.includes(c))extraConns.push(c);
          c._playerName=joiningName;
          updatePeerStatus('connected ('+extraConns.filter(x=>x&&x.open).length+' guests)');
        }

        // Tell everyone updated roster
        broadcast({type:'ROSTER_UPDATE',players:roomPlayers.map(p=>({name:p.name,isHost:p.isHost})),roles:playerRoles});
        if(document.getElementById('screen-lobby').classList.contains('active'))renderRoster();
        // Send welcome with full state to joiner
        c.send({type:'WELCOME',hostName:myName,inGame:currentMatchMode!=="",players:roomPlayers.map(p=>({name:p.name,isHost:p.isHost})),roles:playerRoles});
        return; // don't fall through to generic handleData for JOIN
      }

      // All other messages ‚Äî route through handleData
      handleData(data,c);
    });

    c.on('close',()=>{
      extraConns=extraConns.filter(x=>x!==c);
      const leaverEntry=roomPlayers.find(p=>p._conn===c);
      const leaverName=leaverEntry?.name||'A player';

      if(currentMatchMode!==""){
        const wasPlayer=(playerRoles[leaverName]==='player');
        if(wasPlayer){
          document.getElementById('pause-msg').innerText=`${leaverName.toUpperCase()} DISCONNECTED.\nWAITING TO RECONNECT...`;
          document.getElementById('pause-overlay').classList.add('open');
          // Don't remove from roomPlayers yet ‚Äî keep slot open for reconnect
        } else {
          roomPlayers=roomPlayers.filter(p=>p._conn!==c);
          broadcast({type:'PLAYER_LEFT',name:leaverName});
        }
      } else {
        roomPlayers=roomPlayers.filter(p=>p._conn!==c);
        broadcast({type:'PLAYER_LEFT',name:leaverName});
        if(document.getElementById('screen-lobby').classList.contains('active'))renderRoster();
      }
      updatePeerStatus('hosting ('+extraConns.filter(x=>x&&x.open).length+' guests)');
    });

    c.on('error',err=>{
      extraConns=extraConns.filter(x=>x!==c);
      console.error('Guest conn error:',err);
    });
  });
}

function connectToPeer(reconnectHostID=null){
  if(peer)peer.destroy();
  peer=null; conn=null;

  // Case-insensitive host lookup
  const rawInput=reconnectHostID||document.getElementById('join-room-id').value.trim();
  const targetID=rawInput.replace(/\s+/g,'_').toLowerCase();
  if(!targetID)return;

  // Guest always uses their own username as their PeerJS ID
  // so the host can identify them on reconnect
  const myPeerID=myName.replace(/\s+/g,'_').toLowerCase()+'_guest';

  updatePeerStatus('connecting...');

  // Try to create peer with our known ID first; fall back to random if taken
  function createGuestPeer(useID){
    const cfg=useID?{...peerConfig}:peerConfig;
    peer=useID?new Peer(useID,cfg):new Peer(cfg);

    peer.on('open',()=>{
      conn=peer.connect(targetID,{reliable:true});

      conn.on('open',()=>{
        updatePeerStatus('connected');
        isHost=false;
        // Send JOIN with reconnect flag if we have a session
        const hasSession=!!localStorage.getItem('fnaf_active_session');
        conn.send({type:'JOIN',name:myName,reconnecting:hasSession});
        if(!reconnectHostID){
          // Fresh join ‚Äî go to lobby
          showScreen('screen-lobby');
        }
        // If reconnecting, wait for host to send REJOIN_STATE
      });

      conn.on('data',data=>handleData(data,conn));

      conn.on('error',err=>{
        if(!reconnectHostID){
          alert("Could not connect. Check the host username.");
          updatePeerStatus('fail',true);
        } else {
          // Auto-retry
          scheduleReconnect(targetID);
        }
      });

      conn.on('close',()=>{
        updatePeerStatus('disconnected');
        if(currentMatchMode!==""){
          document.getElementById('pause-msg').innerText="CONNECTION LOST.\nAUTO-RECONNECTING...";
          document.getElementById('pause-overlay').classList.add('open');
          scheduleReconnect(targetID);
        }
      });
    });

    peer.on('error',err=>{
      if(err.type==='unavailable-id'&&useID){
        // Our ID is taken (maybe our old session is still alive) ‚Äî use random ID
        createGuestPeer(null);
      } else if(reconnectHostID){
        scheduleReconnect(targetID);
      } else {
        updatePeerStatus('error: '+err.type,true);
      }
    });
  }

  createGuestPeer(myPeerID);
}

function scheduleReconnect(hostID){
  if(reconnectTimer)clearTimeout(reconnectTimer);
  reconnectTimer=setTimeout(()=>{
    if(document.getElementById('pause-overlay').classList.contains('open')){
      updatePeerStatus('retrying...');
      connectToPeer(hostID);
    }
  },3000);
}

function attemptReconnect(){
  const sessionStr=localStorage.getItem('fnaf_active_session');
  if(sessionStr){
    const session=JSON.parse(sessionStr);
    const hostID=session.hostID;
    if(hostID){connectToPeer(hostID);}
    else{disconnect(true);}
  } else {
    disconnect(true);
  }
}

function handleData(data,fromConn){
  // HOST: relay game messages to all other connections
  if(isHost&&fromConn){
    if(['TARGET_SET','TARGET_REVEAL','GAME_OVER','BOARD_UPDATE'].includes(data.type)){
      if(!data.from)data.from=fromConn._playerName||'unknown';
      broadcast(data,fromConn);
    }
  }

  // ‚îÄ‚îÄ REJOIN_STATE: guest is resuming after reconnect ‚îÄ‚îÄ
  if(data.type==='REJOIN_STATE'){
    activeRoster=data.roster;
    playerRoles=data.roles||{};
    player1Name=data.player1||null;
    player2Name=data.player2||null;
    myRole=playerRoles[myName]||'spectator';
    // Restore session state
    const sessionStr=localStorage.getItem('fnaf_active_session');
    if(sessionStr){
      const session=JSON.parse(sessionStr);
      flippedCards=new Set(session.flippedCards||[]);
      myTargetForOpponent=session.myTargetForOpponent||null;
      myTargetObj=session.myTargetObj||null;
      opponentTargetForMe=session.opponentTargetForMe||null;
      currentMatchMode=session.mode||'';
    }
    document.getElementById('pause-overlay').classList.remove('open');
    showScreen('game-ui');
    updateMyRoleDisplay();
    if(myRole==='spectator'){enterSpectatorMode();}
    else{
      // Restore target display
      if(myTargetObj){
        document.getElementById('target-display').innerHTML=`<div class="target-label">YOUR ANIMATRONIC</div><img src="${myTargetObj.img}" onerror="this.src='https://placehold.co/150x150/100/600?text=?'"><div class="target-name">${myTargetObj.name}</div>`;
      }
      // Re-send our target to host so opponent gets it too
      if(myTargetForOpponent){
        broadcast({type:'TARGET_SET',from:myName,target:myTargetForOpponent});
      }
      renderMatchBoard(currentMatchMode||'choose');
      checkSync();
    }
    saveSession();
    return;
  }

  // ‚îÄ‚îÄ Process messages ‚îÄ‚îÄ
  if(data.type==='TERMINATE'){
    // Host intentionally ended ‚Äî clean disconnect, no retry
    clearSession();
    if(peer){try{peer.destroy();}catch(e){}}
    peer=null; conn=null; extraConns=[];
    currentMatchMode=""; myRole='player';
    updatePeerStatus('disconnected');
    setInMatchMode(false);
    showScreen('screen-main');
    alert(data.reason||'Room closed.');
    return;
  }
  if(data.type==='WELCOME'){
    roomPlayers=data.players||[];
    playerRoles=data.roles||{};
    if(!playerRoles[myName])playerRoles[myName]='spectator';
    renderRoster();
  }
  if(data.type==='ROSTER_UPDATE'){
    roomPlayers=data.players||[];
    playerRoles=data.roles||{};
    if(document.getElementById('screen-lobby').classList.contains('active'))renderRoster();
    updateMyRoleDisplay();
  }
  if(data.type==='ROLE_ASSIGN'){
    playerRoles=data.roles;
    myRole=playerRoles[myName]||'spectator';
    updateMyRoleDisplay();
    if(document.getElementById('screen-lobby').classList.contains('active'))renderRoster();
  }
  if(data.type==='PLAYER_LEFT'){
    roomPlayers=roomPlayers.filter(p=>p.name!==data.name);
    if(document.getElementById('screen-lobby').classList.contains('active'))renderRoster();
  }
  if(data.type==='START'){
    activeRoster=data.roster;
    playerRoles=data.roles||{};
    player1Name=data.player1||null;
    player2Name=data.player2||null;
    myRole=playerRoles[myName]||'spectator';
    resetGameState();
    showScreen('game-ui');
    if(myRole==='spectator'){enterSpectatorMode();}
    else{renderMatchBoard('choose');}
    saveSession();
  }
  if(data.type==='TARGET_REVEAL'){
    // Spectators store and display both players' chosen cards
    if(myRole==='spectator'&&data.from&&data.target){
      spectatorTargets[data.from]=data.target;
      updateSpectatorTargetDisplay();
    }
  }
  if(data.type==='TARGET_SET'){
    const from=data.from||'';
    if(myRole==='player'){
      if(from!==myName){opponentTargetForMe=data.target;checkSync();}
    }
    saveSession();
    // HOST relay is already done at top of handleData ‚Äî don't double-relay
  }
  if(data.type==='BOARD_UPDATE'){
    if(myRole==='spectator'){
      spectatorBoardStates[data.from]=new Set(data.flipped);
      renderSpectatorBoard();
    }
  }
  if(data.type==='GAME_OVER'){
    clearSession();
    showEndScreen(data.result,data.guesser,data.guessedChar,data.p1Target,data.p2Target);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROLE MANAGEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateMyRoleDisplay(){
  myRole=playerRoles[myName]||'spectator';
  const badge=document.getElementById('role-badge');
  if(badge){
    if(myRole==='player'){badge.className='panel-role-badge role-player';badge.textContent='‚óè PLAYER';}
    else{badge.className='panel-role-badge role-spectator';badge.textContent='‚óà SPECTATOR';}
  }
  const myRoleDiv=document.getElementById('my-role-display');
  if(myRoleDiv&&myRoleDiv.style.display!=='none'){
    myRoleDiv.innerText=`YOUR ROLE: ${myRole.toUpperCase()}`;
    myRoleDiv.style.color=myRole==='player'?'var(--green)':'#cc88ff';
  }
}

function hostAssignRole(playerName,role){
  if(!isHost)return;
  playerRoles[playerName]=role;
  // Count players
  const players=Object.entries(playerRoles).filter(([,r])=>r==='player');
  if(players.length>2){
    // Demote the oldest player to spectator
    // find the first one who isn't playerName
    const todemote=players.find(([n])=>n!==playerName);
    if(todemote)playerRoles[todemote[0]]='spectator';
  }
  broadcast({type:'ROLE_ASSIGN',roles:{...playerRoles}});
  renderRoster();
}

function countPlayersWithRole(role){return Object.values(playerRoles).filter(r=>r===role).length;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderRoster(){
  const div=document.getElementById('player-roster');
  div.innerHTML='';
  const allPlayers=isHost?roomPlayers:roomPlayers;
  allPlayers.forEach(p=>{
    const role=playerRoles[p.name]||'spectator';
    const roleColor=role==='player'?'#66ff66':'#cc88ff';
    let roleControl='';
    if(isHost&&!p.isHost){
      roleControl=`<select class="role-select" onchange="hostAssignRole('${p.name}',this.value)">
        <option value="player"${role==='player'?' selected':''}>PLAYER</option>
        <option value="spectator"${role==='spectator'?' selected':''}>SPECTATOR</option>
      </select>`;
    } else if(p.isHost){
      roleControl=`<span class="lobby-badge badge-host">HOST</span>`;
    }
    div.innerHTML+=`<div class="lobby-player-row">
      <div class="lobby-player-dot"></div>
      <div class="lobby-player-name">${p.name}</div>
      <span class="lobby-badge" style="color:${roleColor};border-color:${roleColor};">${role.toUpperCase()}</span>
      ${roleControl}
    </div>`;
  });

  document.getElementById('host-controls').style.display=isHost?'block':'none';
  document.getElementById('guest-waiting').style.display=isHost?'none':'block';

  const myRoleDiv=document.getElementById('my-role-display');
  myRoleDiv.style.display='block';
  myRoleDiv.style.fontFamily='var(--hud)';
  myRoleDiv.style.fontSize='10px';
  myRoleDiv.style.letterSpacing='2px';
  updateMyRoleDisplay();

  if(isHost){
    const sel=document.getElementById('lobby-board-select');
    sel.innerHTML=Object.keys(savedBoards).map(b=>`<option value="${b}">${b}</option>`).join('');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOARDS MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openBoardManager(){document.getElementById('editor-search').value='';showScreen('screen-boards');renderBoardList();}
function renderBoardList(){
  const list=document.getElementById('board-list');
  list.innerHTML=Object.keys(savedBoards).map(name=>`
    <div class="list-item"><span style="font-weight:700;">${name}</span>
    <div style="display:flex;gap:3px;">
      <button class="btn-tiny" onclick="editBoard('${name}')">‚úè EDIT</button>
      <button class="btn-tiny" onclick="renameBoard('${name}')">‚úé RENAME</button>
      <button class="btn-tiny" style="color:#660000;" onclick="deleteBoard('${name}')">‚úï DEL</button>
    </div></div>`).join('');
}
function renameBoard(oldName){const n=prompt("New name:",oldName);if(n&&n!==oldName&&!savedBoards[n]){savedBoards[n]=savedBoards[oldName];delete savedBoards[oldName];saveUserData();renderBoardList();}}
function deleteBoard(name){if(Object.keys(savedBoards).length<=1)return alert("Cannot delete last board!");if(confirm(`Delete '${name}'?`)){delete savedBoards[name];saveUserData();renderBoardList();}}
function createNewBoard(){const name=document.getElementById('new-board-name').value.trim();if(!name||savedBoards[name])return;savedBoards[name]=masterRoster.map(c=>({...c}));saveUserData();renderBoardList();document.getElementById('new-board-name').value='';}
function editBoard(name){currentBoardName=name;showScreen('screen-editor');document.getElementById('editing-title').innerText=name;renderVisualEditor();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderVisualEditor(){
  const grid=document.getElementById('editor-grid');grid.innerHTML='';
  const query=document.getElementById('editor-search').value.toLowerCase();
  let totalEnabled=0;
  categories.forEach(cat=>{
    const items=savedBoards[currentBoardName].slice(cat.range[0],cat.range[1]+1).filter(c=>!query||c.name.toLowerCase().includes(query));
    if(!items.length)return;
    const sec=document.createElement('div');sec.className='section-group';sec.id=`section-${cat.id}-editor-scroll`;
    sec.innerHTML=`<div class="section-header"><div class="section-name">${cat.title}</div><button class="btn-tiny" onclick="toggleCategory('${cat.id}',true)">‚òë ALL ON</button><button class="btn-tiny" onclick="toggleCategory('${cat.id}',false)">‚òê ALL OFF</button></div><div class="char-grid" id="cg-${cat.id}"></div>`;
    grid.appendChild(sec);
    const cg=sec.querySelector(`#cg-${cat.id}`);
    items.forEach(char=>{
      if(char.enabled)totalEnabled++;
      const card=document.createElement('div');card.className=`editor-card ${char.enabled?'enabled':'disabled'}`;card.dataset.id=char.id;
      card.onmousedown=e=>{e.preventDefault();startDragSelect(char.id);};
      card.onmouseenter=()=>{if(isDragging)handleToggle(char.id);};
      card.innerHTML=`<img src="${char.img}" onerror="this.src='https://placehold.co/120x120/100/600?text=?'"><div class="card-name-tag">${char.name}</div>`;
      cg.appendChild(card);
    });
  });
  const badge=document.getElementById('editor-count');if(badge)badge.innerText=`${totalEnabled} ENABLED`;
}
function toggleCategory(catId,state){const cat=categories.find(c=>c.id===catId);if(!cat)return;for(let i=cat.range[0];i<=cat.range[1];i++)savedBoards[currentBoardName][i].enabled=state;renderVisualEditor();}
function handleToggle(id){
  if(lastToggledId===id)return;
  const char=savedBoards[currentBoardName].find(c=>c.id===id);
  if(char){
    char.enabled=dragTargetState;
    lastToggledId=id;
    // Update just this card's class ‚Äî no full re-render
    const card=document.querySelector(`.editor-card[data-id="${id}"]`);
    if(card){
      card.className=`editor-card ${char.enabled?'enabled':'disabled'}`;
    }
    // Update the count badge only
    const totalEnabled=savedBoards[currentBoardName].filter(c=>c.enabled).length;
    const badge=document.getElementById('editor-count');
    if(badge)badge.innerText=`${totalEnabled} ENABLED`;
  }
}
function startDragSelect(startId){isDragging=true;const char=savedBoards[currentBoardName].find(c=>c.id===startId);dragTargetState=!char.enabled;lastToggledId=null;handleToggle(startId);}
document.body.addEventListener('mouseup',()=>{isDragging=false;dragTargetState=null;lastToggledId=null;});
function bulkToggle(state){savedBoards[currentBoardName].forEach(c=>c.enabled=state);renderVisualEditor();}
function saveEditor(){saveUserData();openBoardManager();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function disconnect(silent=false){
  if(reconnectTimer)clearTimeout(reconnectTimer);
  if(!silent){
    broadcast({type:'TERMINATE',reason:isHost?'HOST LEFT THE GAME':'PLAYER LEFT'});
  }
  if(!silent)clearSession();
  // Close all connections
  extraConns.forEach(c=>{try{if(c&&c.open)c.close();}catch(e){}});
  if(conn){try{if(conn.open)conn.close();}catch(e){}}
  if(peer){try{peer.destroy();}catch(e){}}
  peer=null; conn=null; extraConns=[];
  currentMatchMode=""; isHost=false; myRole='player';
  updatePeerStatus('disconnected');
  setInMatchMode(false);
  showScreen('screen-main');
  checkSession();
}

function signalStart(){
  // Validate
  const players=Object.entries(playerRoles).filter(([,r])=>r==='player').map(([n])=>n);
  if(players.length!==2)return alert("Exactly 2 players must have the PLAYER role before starting!");
  const bName=document.getElementById('lobby-board-select').value;
  const roster=savedBoards[bName].filter(c=>c.enabled);
  if(roster.length<2)return alert("Select at least 2 animatronics!");

  player1Name=players[0];
  player2Name=players[1];

  const startMsg={type:'START',roster,roles:{...playerRoles},player1:player1Name,player2:player2Name};
  broadcast(startMsg);

  myRole=playerRoles[myName]||'spectator';
  activeRoster=roster;
  resetGameState();
  showScreen('game-ui');
  if(myRole==='spectator'){enterSpectatorMode();}
  else{renderMatchBoard('choose');}
  saveSession();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetGameState(){
  myTargetForOpponent=null;opponentTargetForMe=null;myTargetObj=null;
  flippedCards.clear();historyStack=[];redoStack=[];updateHistoryButtons();
  spectatorBoardStates={};
  spectatorTargets={};
  document.getElementById('match-search').value='';
  document.getElementById('target-display').innerHTML=`<div style="font-family:var(--hud);font-size:9px;letter-spacing:2px;color:#222;">AWAITING SELECTION</div>`;
  document.getElementById('user-tag').innerText=myName.toUpperCase();
  document.getElementById('game-status').innerText="SELECT YOUR ANIMATRONIC";
  document.getElementById('invert-btn').style.display='none';
  document.getElementById('spectator-info').style.display='none';
  document.getElementById('target-display').style.display='flex';
  document.getElementById('history-section').style.display='block';
  currentMatchMode="";
  updateMyRoleDisplay();
  applyZoom();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SPECTATOR MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function enterSpectatorMode(){
  document.getElementById('game-status').innerText="SPECTATING";
  document.getElementById('target-display').style.display='none';
  document.getElementById('history-section').style.display='none';
  document.getElementById('invert-btn').style.display='none';
  document.getElementById('spectator-info').style.display='block';
  document.getElementById('spec-p1-name').innerText=player1Name||'Player 1';
  document.getElementById('spec-p2-name').innerText=player2Name||'Player 2';
  updateSpectatorTargetDisplay();

  const bw=document.getElementById('board-wrapper');
  bw.classList.add('spectator-mode');
  bw.innerHTML=''; // clear

  // Left half: player 1
  const left=document.createElement('div');
  left.className='spectator-half';left.id='spec-half-1';
  left.innerHTML=`<div class="spectator-header p1">üëÅ ${player1Name||'PLAYER 1'}</div><div id="spec-board-1"></div>`;
  // Right half: player 2
  const right=document.createElement('div');
  right.className='spectator-half';right.id='spec-half-2';
  right.innerHTML=`<div class="spectator-header p2">üëÅ ${player2Name||'PLAYER 2'}</div><div id="spec-board-2"></div>`;

  bw.appendChild(left);
  bw.appendChild(right);
  renderSpectatorBoard();
}

function updateSpectatorTargetDisplay(){
  [['p1',player1Name],['p2',player2Name]].forEach(([slot,pname])=>{
    if(!pname)return;
    const t=spectatorTargets[pname];
    const waitEl=document.getElementById(`spec-target-${slot}-waiting`);
    const imgEl=document.getElementById(`spec-target-${slot}-img`);
    const nameEl=document.getElementById(`spec-target-${slot}-name`);
    const labelEl=document.getElementById(`spec-target-${slot}-label`);
    if(!waitEl||!imgEl||!nameEl)return;
    if(labelEl)labelEl.textContent=pname.toUpperCase().substring(0,8);
    if(t){
      waitEl.style.display='none';
      imgEl.src=t.img;imgEl.style.display='block';
      nameEl.textContent=t.name;
    } else {
      waitEl.style.display='block';
      imgEl.style.display='none';
      nameEl.textContent='';
    }
  });
}

function renderSpectatorBoard(){
  [player1Name,player2Name].forEach((pname,idx)=>{
    if(!pname)return;
    const boardDiv=document.getElementById(`spec-board-${idx+1}`);
    if(!boardDiv)return;
    boardDiv.innerHTML='';
    const pFlipped=spectatorBoardStates[pname]||new Set();
    const query=document.getElementById('match-search').value.toLowerCase();

    categories.forEach(cat=>{
      const items=activeRoster.filter(char=>{
        const gi=masterRoster.findIndex(m=>m.name===char.name);
        return gi>=cat.range[0]&&gi<=cat.range[1];
      }).filter(char=>!query||char.name.toLowerCase().includes(query));
      if(!items.length)return;

      const sec=document.createElement('div');sec.className='board-section-group';
      sec.innerHTML=`<div class="board-section-header"><div class="board-section-title">${cat.title} <span class="count-badge">${items.length}</span></div></div><div class="board-grid" id="sg-${idx}-${cat.id}"></div>`;
      boardDiv.appendChild(sec);
      const bg=sec.querySelector(`#sg-${idx}-${cat.id}`);
      items.forEach(char=>{
        const card=document.createElement('div');
        card.className='card'+(pFlipped.has(char.name)?' flipped':'');
        card.dataset.name=char.name;
        card.innerHTML=`<div class="card-inner"><div class="card-front"><img src="${char.img}" onerror="this.src='https://placehold.co/120x120/100/600?text=?'"><div class="card-label">${char.name}</div><div class="card-btn-row"></div></div><div class="card-back"><div class="out-text">OUT</div></div></div>`;
        bg.appendChild(card);
      });
    });
  });
}

let _searchDebounce=null;
function refreshMatchBoard(){
  clearTimeout(_searchDebounce);
  _searchDebounce=setTimeout(()=>renderMatchBoard(currentMatchMode),80);
}

function toggleFlipState(name,cardEl){
  if(myRole==='spectator')return;
  saveHistory([name]);
  flippedCards.has(name)?flippedCards.delete(name):flippedCards.add(name);
  cardEl.classList.toggle('flipped',flippedCards.has(name));
  saveSession();
  // Broadcast flip state to spectators
  broadcast({type:'BOARD_UPDATE',from:myName,flipped:Array.from(flippedCards)});
}

function renderMatchBoard(mode){
  currentMatchMode=mode;
  const board=document.getElementById('game-board');
  board.innerHTML='';
  const query=document.getElementById('match-search').value.toLowerCase();
  const jumpSelect=document.getElementById('match-jump');
  jumpSelect.innerHTML='<option value="">JUMP TO SECTION...</option>';

  categories.forEach(cat=>{
    const items=activeRoster.filter(char=>{
      const gi=masterRoster.findIndex(m=>m.name===char.name);
      return gi>=cat.range[0]&&gi<=cat.range[1];
    }).filter(char=>!query||char.name.toLowerCase().includes(query));
    if(!items.length)return;

    jumpSelect.innerHTML+=`<option value="${cat.id}">${cat.title}</option>`;
    const sec=document.createElement('div');sec.className='board-section-group';sec.id=`section-${cat.id}-board-wrapper`;
    sec.innerHTML=`<div class="board-section-header"><div class="board-section-title">${cat.title} <span class="count-badge">${items.length}</span></div>${mode==='guess'?`<button class="btn-tiny" onclick="bulkMatchToggle('${cat.id}',false)">OUT ALL</button><button class="btn-tiny" onclick="bulkMatchToggle('${cat.id}',true)">IN ALL</button>`:''}</div><div class="board-grid" id="bg-${cat.id}"></div>`;
    board.appendChild(sec);

    const bg=sec.querySelector(`#bg-${cat.id}`);
    items.forEach(char=>{
      const card=document.createElement('div');
      card.className='card'+(flippedCards.has(char.name)?' flipped':'');
      card.dataset.name=char.name;

      const actionBtn=mode==='choose'
        ?`<button class="card-action-btn choose-btn" onclick="event.stopPropagation();lockTarget('${char.name.replace(/'/g,"\\'")}','${char.img.replace(/'/g,"\\'")}')">CHOOSE</button>`
        :`<button class="card-action-btn guess-btn" onclick="event.stopPropagation();confirmGuess('${char.name.replace(/'/g,"\\'")}','${char.img.replace(/'/g,"\\'")}')">GUESS</button>`;

      card.innerHTML=`<div class="card-inner"><div class="card-front"><img src="${char.img}" onerror="this.src='https://placehold.co/120x120/100/600?text=?'"><div class="card-label">${char.name}</div><div class="card-btn-row">${actionBtn}</div></div><div class="card-back"><div class="out-text">OUT</div></div></div>`;
      if(mode==='guess')card.onclick=()=>toggleFlipState(char.name,card);
      bg.appendChild(card);
    });
  });
  updateHistoryButtons();
}

function bulkMatchToggle(catId,state){
  if(!confirm("Are you sure?"))return;
  const cat=categories.find(c=>c.id===catId);
  const affected=activeRoster.filter(char=>{const gi=masterRoster.findIndex(m=>m.name===char.name);return gi>=cat.range[0]&&gi<=cat.range[1];}).map(c=>c.name);
  saveHistory(affected);
  affected.forEach(name=>state?flippedCards.delete(name):flippedCards.add(name));
  refreshMatchBoard();saveSession();
  broadcast({type:'BOARD_UPDATE',from:myName,flipped:Array.from(flippedCards)});
}

function confirmGuess(name,img){if(confirm(`FINAL ANSWER: "${name}"?`))checkWin(name,img);}

function lockTarget(name,img){
  myTargetForOpponent=name;myTargetObj={name,img};
  document.getElementById('target-display').innerHTML=`<div class="target-label">YOUR ANIMATRONIC</div><img src="${img}" onerror="this.src='https://placehold.co/150x150/100/600?text=?'"><div class="target-name">${name}</div>`;
  // To opponent: only send name (keep card hidden from them)
  broadcast({type:'TARGET_SET',from:myName,target:name});
  // To spectators: send full card info so they can see both secrets
  broadcast({type:'TARGET_REVEAL',from:myName,target:{name,img}});
  // If host is also a player, record own reveal for spectators directly
  if(isHost){
    spectatorTargets[myName]={name,img};
    updateSpectatorTargetDisplay();
  }
  checkSync();
  saveSession();
}

function checkSync(){
  if(myTargetForOpponent&&opponentTargetForMe){
    document.getElementById('sync-overlay').classList.remove('open');
    document.getElementById('game-status').innerText="GUESS OPPONENT'S ANIMATRONIC";
    document.getElementById('invert-btn').style.display='block';
    renderMatchBoard('guess');
  } else if(myTargetForOpponent){
    document.getElementById('sync-overlay').classList.add('open');
  }
}

function invertFlippedCards(){
  const allNames=activeRoster.map(c=>c.name);
  saveHistory(allNames);
  allNames.forEach(name=>flippedCards.has(name)?flippedCards.delete(name):flippedCards.add(name));
  refreshMatchBoard();saveSession();
  broadcast({type:'BOARD_UPDATE',from:myName,flipped:Array.from(flippedCards)});
}

function checkWin(name,img){
  const win=name===opponentTargetForMe;
  const result=win?'VICTORY':'DEFEAT';
  const p1t=player1Name===myName?myTargetObj:activeRoster.find(c=>c.name===myTargetForOpponent)||{name:name,img};
  const p2t=player2Name===myName?myTargetObj:activeRoster.find(c=>c.name===myTargetForOpponent)||{name:name,img};
  const myT=myTargetObj||{name:'?',img:''};
  const oppT=opponentTargetForMe?activeRoster.find(c=>c.name===opponentTargetForMe)||{name:opponentTargetForMe,img:`Animatronics/${opponentTargetForMe}.webp`}:{name:'?',img:''};
  broadcast({type:'GAME_OVER',result:win?'DEFEAT':'VICTORY',guesser:myName,guessedChar:{name,img},p1Target:player1Name===myName?myT:oppT,p2Target:player2Name===myName?myT:oppT});
  clearSession();
  showEndScreen(result,myName,{name,img},player1Name===myName?myT:oppT,player2Name===myName?myT:oppT);
}

function showEndScreen(result,guesser,charObj,p1Target,p2Target){
  currentMatchMode="";
  setInMatchMode(false);
  const bw=document.getElementById('board-wrapper');bw.classList.remove('spectator-mode');bw.innerHTML='<div id="game-board"></div>';
  const banner=document.getElementById('end-result-banner');
  if(banner){banner.innerText=result;banner.style.color=result==='VICTORY'?'#ffd700':'#ff2200';}
  document.getElementById('end-guesser-name').innerText=guesser.toUpperCase();
  document.getElementById('end-guess-name').innerText=charObj.name;
  document.getElementById('end-guess-img').src=charObj.img;
  if(p1Target){document.getElementById('end-p1-img').src=p1Target.img||'';document.getElementById('end-p1-name').innerText=(p1Target.name||'?').toUpperCase();}
  if(p2Target){document.getElementById('end-p2-img').src=p2Target.img||'';document.getElementById('end-p2-name').innerText=(p2Target.name||'?').toUpperCase();}
  showScreen('screen-game-over');
}
</script>
</body>
</html>
